//Задача. Получить от клиента Имя и телефон. Далее просто передаём данные в Jivo и переводим диалог на оператора
//Тут описан код, который использовался для определения информации

//Разбираме по частям регулярное выражение:
// ^ - начало строки
// \s* - любое количество пробелов в начале
// (?: — начало непоименованной группы.
// \+? - опциональный плюс
//(\d{1,3})) - одна - три цифры (код города или страны)
// )? - конец необязательно группы
//  [-. (]* — ноль или больше символов -, ., ( или ).
// (\d{3}) — три цифры (код города), захватываемые во вторую группу.
// [-. )]* — ноль или больше символов -, ., ) или .
// (\d{3}) — три цифры (следующие три цифры номера), захватываемые в третью группу.
// [-. ]* — ноль или больше символов -, ., или .
// (\d{4}) — четыре цифры (последние четыре цифры номера), захватываемые в четвертую группу.
// (?: — начало непоименованной группы.
// *x(\d+) — ноль или больше пробелов, за которыми следует буква x и одна или несколько цифр (добавочный номер), захватываемых в пятую группу.
// )? — конец необязательной группы.
// \s*$ — ноль или больше пробелов в конце строки и конец строки.


//$session - объект в котором хранятся данные полученные в процессе работы бота
//Установил флаг, для зацикливания процесса
$session.flag = 0
//Заранее, создаём счётчик. Он не инициализируется в рамках этого кода, так как подразумевается, что получив $session.answer мы перемещаемся на другой state и при необходимости возвращаемся обратно сюда. Запуская процесс заново.
//$session.countAnswer = 0;
//Создаём переменную под ответ
$session.answer = "";
//Определение функции checkValue, которая на вход получает строку $session.phone
function checkValue(phone) {

    //Создаём две переменные для регулярных выражений. Первая проверяет телефон
    //var phoneRegex = /^\s*(?:\+?(\d{1,4}))?[-. (]*(\d{3})[-. )]*(\d{3})[-. ]*(\d{4})(?: *x(\d+))?\s*$/; 
    var phoneRegex = /^\D*(\d\D*){10,11}$/
    //Вторая проверяет почту
    //var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    //Можно использовать простой вариант
    var emailRegex = /@/;

    //В условии IF мы проверяем на соответствие с использование регулярного выражения через метод test(). 
    //Когда мы применяем регулярное выражение к строке с помощью метода test(), движок регулярных выражений проходит через каждую позицию строки и сравнивает её с шаблоном. 
    //Если он находит совпадение, он продолжает двигаться дальше по строке. Если он достигает конца строки и все символы совпадают с шаблоном, метод test() возвращает true.
    if (phoneRegex.test(phone)) {
    //Если клиент ввёл номер, то меняем флаг на true и погнали дальше сценарий
        $session.flag = 1
    //Если клиент ввёл почту. То начинает его гонять по кругу, пока не введёт номер телефона. $session.countAnswer позволяет миксовать ответы
    } else if (emailRegex.test(phone)) {
            if($session.countAnswer === 0){
                    $session.answer = "Понимаю ваше желание начать с электронной почты.Мы ценим ваш интерес и готовы предоставить всю необходимую информацию.Однако если у вас будет возможность,пожалуйста,сообщите ваш номер телефона.Это позволит нам более эффективно и быстро решить ваш вопрос."; 
                    $session.countAnswer += 1        
                } else if ($session.countAnswer === 1){
                    $session.answer = "Понимаю ваше предпочтение.Однако для более быстрого и удобного общения,пожалуйста,оставьте ваш номер телефона. Это позволит нашему менеджеру оперативно связаться с вами и ответить на вопросы.";
                    $session.countAnswer += 1
                } else if ($session.countAnswer === 2){
                    $session.answer = "Конечно, мы можем отправить информацию на электронную почту. Однако для этого мне нужно ваше имя и номер телефона , чтобы наш менеджер мог связаться с вами и уточнить детали.";           
                    $session.countAnswer += 1        
                } else {
                    $session.answer = "Конечно,мы можем отправить информацию на электронную почту .Для этого, пожалуйста, оставьте ваш номер телефона, чтобы наш менеджер мог уточнить все необходимые детали и отправить информацию на вашу почту.";            
                    $session.countAnswer += 1        
                }
    } else {
        //Просто рандомный ответ     
        $session.answer = "Оставьте пожалуйста номер телефона. Наши сотрудники свяжутся с вами и смогут ответить на все ваши вопросы";    
        }}
    //
    checkValue($session.phone)

